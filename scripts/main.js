"use strict";function uuid(){var e="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0,a="x"===e?t:3&t|8;return a.toString(16)});return e}function addMap(){var e="pk.eyJ1Ijoic2lnZ3lmIiwiYSI6Il8xOGdYdlEifQ.3-JZpqwUa3hydjAJFXIlMA";map=L.map("map"),map.setView([52.505,5.09],8),L.tileLayer("https://api.mapbox.com/v4/{mapid}/{z}/{x}/{y}.{format}?access_token={token}",{attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OSM</a>, &copy; <a href="http://cartodb.com/attributions">mapbox</a>',token:e,format:"png",mapid:"mapbox.dark"}).addTo(map),map.properties={editing:!1,deleting:!1},L.Icon.Default.imagePath||(L.Icon.Default.imagePath="styles/images");var t=new L.FeatureGroup;map.addLayer(t);var a={position:"topright",draw:{polyline:!1,polygon:!1,circle:!1,rectangle:{},marker:!1},edit:{featureGroup:t,edit:{selectedPathOptions:{maintainColor:!0,opacity:.3}},remove:{}}},o=new L.Control.Draw(a);map.addControl(o),map.on("draw:created",function(e){var a=(e.layerType,e.layer);a.feature={type:"Feature",properties:{startDate:moment().add(-1,"weeks").toJSON(),endDate:moment().add(1,"weeks").toJSON(),incidentId:uuid()}};var o=a.toGeoJSON();console.log("created",o),a.on("click",function(e){console.log("click",e),map.properties.editing||map.properties.deleting||($("#startDate").data("DateTimePicker").date(moment(a.feature.properties.startDate)),$("#endDate").data("DateTimePicker").date(moment(a.feature.properties.endDate)),$("#modal-form").data(a),$("#modal-form").modal({}))}),t.addLayer(a)}),map.on("draw:edited",function(e){var t=e.layers;t.eachLayer(function(e){var t=e.toGeoJSON();console.log("edited",t)})}),map.on("draw:deletestart",function(e){console.log("about to delete",e),map.properties.deleting=!0}),map.on("draw:editstart",function(e){console.log("about to edit"),map.properties.editing=!0}),map.on("draw:deletestop",function(e){console.log("no more deletes",e),map.properties.deleting=!1}),map.on("draw:editstop",function(e){console.log("no more edits"),map.properties.editing=!1}),map.on("draw:deleted",function(e){var t=e.layers;t.eachLayer(function(e){var t=e.toGeoJSON();console.log("deleted",t)})})}var map;!function(){function e(e){return _.any(_.map(e._latlngs,function(e){return e.lng<-0}))&&(e._latlngs=_.map(e._latlngs,function(e,t){if(t>0){var a;if(e.lng-this[t-1].lng<-180)return a=new L.latLng(e.lat,e.lng+360,!0),this[t]=a,a;if(e.lng-this[t-1].lng>180)return a=new L.latLng(e.lat,e.lng-360,!0),this[t]=a,a}return e},e._latlngs)),e}var t="54.76.43.47",a=new SockJS("http://"+t+"/stomp"),o=Stomp.over(a);o.debug=null,o.heartbeat.outgoing=0,o.heartbeat.incoming=0;var n=function(){console.log("connected"),o.subscribe("/exchange/crisis_crawl",function(t){var a=JSON.parse(t.body),o=a.footprint,n=omnivore.wkt.parse(o);n.setStyle({fillColor:"blue"});var r=_.values(n._layers)[0];r=e(r),n.addTo(map),_.each(_.values(n._layers),function(e){$(e._path).hide().fadeIn().delay(3e3).fadeOut({duration:"slow",complete:function(){map.removeLayer(n)}})}),n.on("click",function(){console.log(this)})}),o.subscribe("/queue/crisis_download",function(t){var a=JSON.parse(t.body),o=a.footprint,n=omnivore.wkt.parse(o);n.setStyle({fillColor:"green"});var r=_.values(n._layers)[0];r=e(r),n.addTo(map),_.each(_.values(n._layers),function(e){$(e._path).hide().fadeIn().delay(1e4).fadeOut({duration:"slow",complete:function(){map.removeLayer(n)}})}),n.on("click",function(){console.log(this)})}),document.addEventListener("incident",function(e){console.log("send to rabbitmq",e.detail),o.send("/exchange/crisis_incident",{"content-type":"application/json"},JSON.stringify(e.detail))})},r=function(e){console.log("error",e)};o.connect("public","public",n,r,"/")}(),function(){window.twttr=function(e,t,a){var o=e.getElementsByTagName(t)[0];if(e.getElementById(a))return window.twttr;var n=e.createElement(t);n.id=a,n.src="https://platform.twitter.com/widgets.js",o.parentNode.insertBefore(n,o);var r={_e:[],ready:function(e){r._e.push(e)}};return window.twttr||r}(document,"script","twitter-wjs")}();var addTweets;!function(){var e=function(e){var t=L.markerClusterGroup({chunkedLoading:!0});_.each(e.features,function(e){var a=e.geometry.coordinates,o=L.marker(L.latLng(a[1],a[0]),{title:e.properties.title});o.bindPopup(e.properties.text),t.addLayer(o)}),map.addLayer(t)},t=function(e){function t(e,t){_.has(e,"properties.oembed.html")?t.bindPopup(e.properties.oembed.html):t.bindPopup(e.properties.text)}var a=L.geoJson(e,{onEachFeature:t,style:{stroke:!0,color:"white",fill:!1}});a.addTo(map),_.each(_.values(a._layers),function(e){$(e._path).hide().fadeIn({duration:"slow"}).delay(15e3).fadeOut({duration:"slow",complete:function(){map.removeLayer(a)}})})};addTweets=function(){_.each(["data/indonesia.json","data/tweets.json"],function(a){fetch(a).then(function(e){return e.json()}).then(function(a){_.isArray(a)?_.each(a,function(e){t(e)}):_.isObject(a)&&("FeatureCollection"===!_.get(a,"type")&&console.error("No feature collection in tweets",a),e(a))})}),map.on("popupopen",function(e){var t=e.popup._contentNode;twttr.widgets.load(t)})}}(),addMap(),addTweets(),$(function(){$("#startDate").datetimepicker(),$("#endDate").datetimepicker(),$("#save").click(function(){$("#modal-form").modal("hide");var e=$("#modal-form").data(),t=e.feature.properties;t.startDate=$("#startDate").data("DateTimePicker").date().toJSON(),t.endDate=$("#endDate").data("DateTimePicker").date().toJSON(),t.tags=$("#tags").val();var a=e.toGeoJSON();console.log("geojson",a);var o=new CustomEvent("incident",{detail:a});document.dispatchEvent(o)})});